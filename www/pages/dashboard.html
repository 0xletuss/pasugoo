<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer Home - Pasugo</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/request-modal.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      /* Map specific styles */
      #map {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }

      /* Custom rider marker styling */
      .rider-marker {
        background: white;
        padding: 8px 12px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        border: 2px solid #ffc107;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
        font-size: 12px;
        white-space: nowrap;
      }

      .rider-marker i {
        color: #ffc107;
        font-size: 16px;
      }

      .rider-distance {
        color: #333;
        font-size: 11px;
      }

      /* User location marker - Icon based */
      .user-location-marker {
        background: white;
        padding: 8px;
        border-radius: 50%;
        border: 3px solid #4285f4;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .user-location-marker i {
        color: #4285f4;
        font-size: 20px;
      }

      /* Loading overlay */
      .location-loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 15px;
      }

      .location-loading.active {
        display: flex;
      }

      /* Authentication warning banner */
      .auth-warning {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: #dc3545;
        color: white;
        padding: 15px;
        text-align: center;
        z-index: 9999;
        display: none;
        font-size: 14px;
        font-weight: 600;
      }

      .auth-warning.show {
        display: block;
      }

      .auth-warning button {
        background: white;
        color: #dc3545;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: 600;
        margin-left: 10px;
        cursor: pointer;
      }

      /* Riders info badge */
      .riders-info-badge {
        position: absolute;
        top: 120px;
        left: 20px;
        background: white;
        padding: 10px 15px;
        border-radius: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 600;
      }

      .riders-info-badge i {
        color: #ffc107;
      }
    </style>
  </head>
  <body>
    <!-- Authentication Warning Banner -->
    <div class="auth-warning" id="authWarning">
      <i class="fa-solid fa-exclamation-triangle"></i>
      Please login to see available riders
      <button id="loginBtn">Login</button>
    </div>

    <!-- Loading indicator -->
    <div class="location-loading" id="locationLoading">
      <div class="spinner-ring"></div>
      <span>Getting your location...</span>
    </div>

    <div class="page-wrapper">
      <div class="map-wrapper">
        <!-- Real Leaflet Map Container -->
        <div id="map"></div>

        <!-- Available Riders Badge -->
        <div class="riders-info-badge">
          <i class="fa-solid fa-motorcycle"></i>
          <span><span id="availableRidersCount">0</span> riders nearby</span>
        </div>

        <div class="floating-search">
          <div class="search-pill">
            <i class="fa-solid fa-magnifying-glass"></i>
            <span>Where to?</span>
          </div>
          <div
            class="control-btn"
            style="border-radius: 50px; width: auto; padding: 0 15px"
          >
            <i class="fa-solid fa-bars"></i>
          </div>
        </div>

        <div class="map-controls">
          <div class="control-btn" id="layerBtn" title="Toggle map layer">
            <i class="fa-solid fa-layer-group"></i>
          </div>
          <div class="control-btn" id="locateBtn" title="My location">
            <i class="fa-solid fa-location-crosshairs"></i>
          </div>
          <div class="control-btn" id="refreshRiders" title="Refresh riders">
            <i class="fa-solid fa-rotate"></i>
          </div>
        </div>
      </div>

      <div class="bottom-sheet">
        <div
          style="
            width: 40px;
            height: 4px;
            background: #eee;
            margin: 0 auto 20px;
            border-radius: 2px;
          "
        ></div>

        <div class="active-request-card">
          <div class="route-icon">
            <i class="fa-solid fa-location-dot"></i>
          </div>
          <div class="route-details">
            <h3 id="locationName">Getting your location...</h3>
            <span style="color: var(--text-light); font-size: 12px">
              Tap <strong>+</strong> below to request a ride
            </span>
          </div>
        </div>
      </div>

      <div class="bottom-nav-dock">
        <a href="#" class="nav-item">
          <i class="fa-solid fa-clock-rotate-left"></i>
        </a>

        <a href="#" class="nav-item">
          <i class="fa-regular fa-bell"></i>
        </a>

        <div class="nav-fab-container">
          <div class="nav-fab">
            <i class="fa-solid fa-plus"></i>
          </div>
        </div>

        <a href="#" class="nav-item active">
          <i class="fa-solid fa-car"></i>
        </a>

        <a href="#" class="nav-item" id="logoutBtn" title="Logout">
          <i class="fa-solid fa-right-from-bracket"></i>
        </a>
      </div>
    </div>
    <!-- ============================================
     CLEAN REQUEST MODAL SYSTEM - NO DUPLICATES
     Replace everything between </div> above and <script> tags below
     ============================================ -->

    <!-- REQUEST FORM MODAL -->
    <div
      class="request-modal-overlay"
      id="requestModalOverlay"
      style="display: none"
    >
      <div class="request-modal" id="requestModal">
        <!-- Header -->
        <div class="modal-header">
          <button class="modal-close" id="closeRequestBtn">
            <i class="fa-solid fa-chevron-down"></i>
          </button>
          <h2 id="formTitle">New Request</h2>
          <div class="modal-progress">
            <span class="step-indicator active" id="step1Indicator">1</span>
            <span class="step-indicator" id="step2Indicator">2</span>
            <span class="step-indicator" id="step3Indicator">3</span>
          </div>
        </div>

        <!-- FORM CONTAINER -->
        <div class="modal-content">
          <!-- STEP 1: SERVICE TYPE -->
          <div class="form-step active" id="step1">
            <h3>What service do you need?</h3>

            <div class="service-grid">
              <div class="service-card" data-service="groceries">
                <i class="fa-solid fa-bag-shopping"></i>
                <span>Buy Groceries</span>
              </div>
              <div class="service-card" data-service="bills">
                <i class="fa-solid fa-receipt"></i>
                <span>Pay Bills</span>
              </div>
              <div class="service-card" data-service="delivery">
                <i class="fa-solid fa-box"></i>
                <span>Pick & Deliver</span>
              </div>
              <div class="service-card" data-service="pharmacy">
                <i class="fa-solid fa-pills"></i>
                <span>Pharmacy</span>
              </div>
              <div class="service-card" data-service="pickup">
                <i class="fa-solid fa-person"></i>
                <span>Pick Me</span>
              </div>
              <div class="service-card" data-service="documents">
                <i class="fa-solid fa-file-contract"></i>
                <span>Documents</span>
              </div>
            </div>

            <button class="btn-primary" id="step1Next" disabled>
              Continue
            </button>
          </div>

          <!-- STEP 2: DETAILS & ITEMS -->
          <div class="form-step" id="step2">
            <h3 id="step2Title">What groceries do you need?</h3>

            <!-- Vehicle Selection (only shows for pickup) -->
            <div id="vehicleSection" style="display: none; margin-bottom: 24px">
              <label
                style="
                  display: block;
                  font-size: 13px;
                  font-weight: 600;
                  color: #333;
                  margin-bottom: 12px;
                "
              >
                Choose Vehicle Type
              </label>
              <div class="vehicle-grid">
                <div class="vehicle-card" data-vehicle="motorcycle">
                  <i class="fa-solid fa-motorcycle"></i>
                  <span>Motorcycle</span>
                </div>
                <div class="vehicle-card" data-vehicle="car">
                  <i class="fa-solid fa-car"></i>
                  <span>Car</span>
                </div>
                <div class="vehicle-card" data-vehicle="van">
                  <i class="fa-solid fa-van-shuttle"></i>
                  <span>Van</span>
                </div>
              </div>
            </div>

            <!-- Bill Photo Upload (only shows for bills) -->
            <div
              id="billPhotoSection"
              style="display: none; margin-bottom: 24px"
            >
              <label
                style="
                  display: block;
                  font-size: 13px;
                  font-weight: 600;
                  color: #333;
                  margin-bottom: 12px;
                "
              >
                Upload Bill Photos
              </label>
              <div class="photo-upload-area" id="photoUploadArea">
                <input
                  type="file"
                  id="billPhotoInput"
                  accept="image/*"
                  multiple
                  style="display: none"
                />
                <div class="upload-placeholder">
                  <i class="fa-solid fa-cloud-arrow-up"></i>
                  <p>Tap to upload bill photos</p>
                  <small>PNG, JPG, GIF up to 10MB</small>
                </div>
              </div>
              <div
                id="photoPreviewContainer"
                class="photo-preview-container"
              ></div>
            </div>
            <div
              id="fileUploadSection"
              style="display: none; margin-bottom: 24px"
            >
              <label>
                <i class="fa-solid fa-paperclip"></i> Attach Files (Optional)
              </label>
              <div class="file-upload-area" id="fileUploadArea">
                <input
                  type="file"
                  id="generalFileInput"
                  accept="*/*"
                  multiple
                  style="display: none"
                />
                <div class="file-upload-placeholder">
                  <i class="fa-solid fa-cloud-arrow-up"></i>
                  <p>Tap to upload files</p>
                  <small
                    >Any file type • Max 25MB per file • Up to 10 files</small
                  >
                </div>
              </div>
              <div
                id="filePreviewContainer"
                class="file-preview-container"
              ></div>
            </div>
            <div class="form-group">
              <label id="itemsLabel">Items List</label>

              <!-- Groceries Items Form (dynamic) -->
              <div id="groceriesItemsForm" style="display: none">
                <div id="itemsContainer"></div>
                <button type="button" id="addItemBtn" class="btn-add-item">
                  <i class="fa-solid fa-plus"></i> Add Item
                </button>
              </div>

              <!-- Pick & Deliver Form -->
              <div id="pickDeliverForm" style="display: none">
                <div style="margin-bottom: 20px">
                  <label
                    style="
                      display: block;
                      font-size: 12px;
                      font-weight: 600;
                      color: #999;
                      margin-bottom: 8px;
                      text-transform: uppercase;
                    "
                  >
                    Items to Pick Up
                  </label>
                  <div id="pickupItemsContainer"></div>
                  <button
                    type="button"
                    id="addPickupItemBtn"
                    class="btn-add-item"
                  >
                    <i class="fa-solid fa-plus"></i> Add Item
                  </button>
                </div>

                <div
                  style="
                    margin-bottom: 20px;
                    padding-bottom: 20px;
                    border-bottom: 1px solid #eee;
                  "
                >
                  <label
                    style="
                      display: block;
                      font-size: 12px;
                      font-weight: 600;
                      color: #999;
                      margin-bottom: 12px;
                      text-transform: uppercase;
                    "
                  >
                    Pickup Location
                  </label>
                  <input
                    type="text"
                    id="pickupLocation"
                    placeholder="E.g., SM Mall Building, Office address..."
                    class="form-input"
                  />
                  <small style="color: #999; display: block; margin-top: 6px"
                    >Where should the rider pick up the items?</small
                  >
                </div>

                <div>
                  <label
                    style="
                      display: block;
                      font-size: 12px;
                      font-weight: 600;
                      color: #999;
                      margin-bottom: 12px;
                      text-transform: uppercase;
                    "
                  >
                    Delivery Option
                  </label>

                  <div class="delivery-option-group">
                    <label class="delivery-option">
                      <input
                        type="radio"
                        name="deliveryOption"
                        value="current-location"
                        checked
                      />
                      <span class="option-content">
                        <i class="fa-solid fa-location-dot"></i>
                        <div>
                          <strong>Deliver to me</strong>
                          <small id="currentLocationDisplay"
                            >Current location</small
                          >
                        </div>
                      </span>
                    </label>

                    <label class="delivery-option">
                      <input
                        type="radio"
                        name="deliveryOption"
                        value="custom-address"
                      />
                      <span class="option-content">
                        <i class="fa-solid fa-map-pin"></i>
                        <div>
                          <strong>Deliver to address</strong>
                          <small>Enter custom location</small>
                        </div>
                      </span>
                    </label>
                  </div>

                  <input
                    type="text"
                    id="deliveryAddress"
                    placeholder="Enter delivery address..."
                    class="form-input"
                    style="display: none; margin-top: 12px"
                  />
                </div>
              </div>

              <!-- Textarea for other services -->
              <textarea
                id="itemsList"
                placeholder="E.g., 2kg rice, 1L milk, 5 eggs, tomatoes..."
                rows="5"
              ></textarea>
              <small id="itemsHelper">List all items you need</small>
            </div>

            <div id="budgetSection" style="display: none">
              <div class="form-group">
                <label>Budget Limit (PHP)</label>
                <input
                  type="number"
                  id="budgetLimit"
                  placeholder="Enter maximum amount"
                  min="0"
                />
                <small>Optional - rider will try to stay within this</small>
              </div>
            </div>

            <div class="form-group">
              <label>Special Instructions</label>
              <textarea
                id="instructions"
                placeholder="Brand preferences, quality notes, etc."
                rows="3"
              ></textarea>
            </div>

            <div class="form-buttons">
              <button class="btn-secondary" id="step2Back">Back</button>
              <button class="btn-primary" id="step2Next">Continue</button>
            </div>
          </div>

          <!-- STEP 3: CONFIRMATION -->
          <div class="form-step" id="step3">
            <h3>Confirm Your Request</h3>

            <div class="confirmation-card">
              <div class="conf-item">
                <span class="label">Service Type:</span>
                <span class="value" id="confService">-</span>
              </div>
              <div class="conf-item" id="confVehicleItem" style="display: none">
                <span class="label">Vehicle:</span>
                <span class="value" id="confVehicle">-</span>
              </div>
              <div class="conf-item">
                <span class="label">Items:</span>
                <span class="value" id="confItems">-</span>
              </div>
              <div class="conf-item">
                <span class="label">Budget:</span>
                <span class="value" id="confBudget">-</span>
              </div>
              <div class="conf-item">
                <span class="label">Pickup/Delivery:</span>
                <span class="value" id="confLocation">-</span>
              </div>
            </div>

            <div class="payment-note">
              <i class="fa-solid fa-info-circle"></i>
              <span
                >You'll confirm payment with the rider when they complete the
                task</span
              >
            </div>

            <div class="form-buttons">
              <button class="btn-secondary" id="step3Back">Back</button>
              <button class="btn-primary" id="submitRequest">
                Find a Rider
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- WAITING FOR RIDER MODAL -->
    <div
      class="waiting-modal-overlay"
      id="waitingModalOverlay"
      style="display: none"
    >
      <div class="waiting-modal" id="waitingModal">
        <button class="modal-close" id="closeWaitingBtn">
          <i class="fa-solid fa-chevron-down"></i>
        </button>

        <div class="waiting-content">
          <div class="pulse-animation">
            <i class="fa-solid fa-motorcycle"></i>
          </div>
          <h3>Finding a rider...</h3>
          <p id="waitingStatus">Looking for available riders near you</p>

          <div class="waiting-timer">
            <span id="waitingTime">0:00</span>
          </div>

          <button class="btn-secondary" id="cancelRequestBtn">
            Cancel Request
          </button>
        </div>
      </div>
    </div>

    <!-- CHAT/TASK MODAL (opens after rider accepts) -->
    <div class="chat-modal-overlay" id="chatModalOverlay" style="display: none">
      <div class="chat-modal" id="chatModal">
        <!-- Header with Rider Info -->
        <div class="chat-header">
          <button class="modal-close" id="closeChatBtn">
            <i class="fa-solid fa-chevron-down"></i>
          </button>
          <div class="rider-info-chat">
            <div class="rider-avatar">
              <i class="fa-solid fa-user"></i>
            </div>
            <div>
              <h4 id="riderName">Rider Name</h4>
              <span id="riderStatus" class="status-badge">On the way</span>
            </div>
          </div>
          <button class="btn-icon" id="riderCallBtn">
            <i class="fa-solid fa-phone"></i>
          </button>
        </div>

        <!-- Task Progress -->
        <div class="task-progress-section">
          <div class="progress-step">
            <div class="progress-circle completed">
              <i class="fa-solid fa-check"></i>
            </div>
            <span>Request Accepted</span>
          </div>
          <div class="progress-step">
            <div class="progress-circle active" id="progressStep2">
              <span>2</span>
            </div>
            <span id="step2Label">Shopping</span>
          </div>
          <div class="progress-step">
            <div class="progress-circle" id="progressStep3">
              <span>3</span>
            </div>
            <span>Delivering</span>
          </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-container" id="chatContainer">
          <div class="message-group system">
            <div class="message-bubble system">
              Rider <strong id="chatRiderName">accepted</strong> your request
            </div>
          </div>
        </div>

        <!-- Message Input -->
        <div class="message-input-section">
          <input
            type="text"
            id="messageInput"
            placeholder="Type a message..."
            class="message-input"
          />
          <button class="btn-send" id="sendMessageBtn">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- OVERLAY BACKDROP - ONE ONLY -->
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <!-- END OF MODAL SECTIONS -->
    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Auth Module (must load before map.js) -->
    <script src="../js/auth.js"></script>

    <!-- Map Controller -->
    <script src="../js/map.js"></script>
    <script src="../js/request-modal.js"></script>

    <!-- Logout handler -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");

        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();

            // Confirm logout
            if (confirm("Are you sure you want to logout?")) {
              // Use the auth module's logout function
              if (window.auth && window.auth.logout) {
                window.auth.logout();
              } else {
                // Fallback: manual logout
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = "login.html";
              }
            }
          });
        }
      });
    </script>
  </body>
</html>
