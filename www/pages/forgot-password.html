<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>Forgot Password - Pasugo</title>
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <div class="page-wrapper">
      <header class="top-header">
        <nav class="nav-bar">
          <a href="login.html" class="nav-back">‚Üê</a>
          <a href="register.html" class="nav-action-link">Register</a>
        </nav>
        <div class="header-content">
          <h1>Reset Password</h1>
          <p>Don't worry! Enter your email and we'll get you back on track.</p>
        </div>
      </header>

      <main class="main-container">
        <div
          id="errorMessage"
          class="alert alert-error"
          style="display: none"
        ></div>
        <div
          id="successMessage"
          class="alert alert-success"
          style="display: none"
        ></div>

        <!-- Step 1: Email Entry -->
        <form id="forgotPasswordForm" style="display: block">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="yourname@email.com"
              required
            />
          </div>

          <button type="submit" id="submitBtn" class="btn btn-primary">
            <span id="btnText">Send Reset Code</span>
            <span id="btnLoader" class="loader" style="display: none"></span>
          </button>
        </form>

        <!-- Step 2: OTP Verification (Hidden initially) -->
        <form id="verifyOTPForm" style="display: none">
          <div class="form-group">
            <label for="otp">Enter Code</label>
            <input
              type="text"
              id="otp"
              name="otp"
              placeholder="000000"
              maxlength="6"
              inputmode="numeric"
              required
            />
            <small
              style="
                display: block;
                margin-top: 8px;
                color: var(--text-light);
                margin-left: 15px;
              "
            >
              6-digit code sent to <span id="emailDisplay"></span>
            </small>
          </div>

          <button type="submit" id="verifyBtn" class="btn btn-primary">
            <span id="verifyBtnText">Verify Code</span>
            <span
              id="verifyBtnLoader"
              class="loader"
              style="display: none"
            ></span>
          </button>

          <div style="text-align: center; margin-top: 20px">
            <small style="color: var(--text-light)">Didn't receive code?</small>
            <button
              type="button"
              id="resendBtn"
              class="btn-link"
              style="
                background: none;
                border: none;
                color: var(--primary-black);
                font-weight: 600;
                cursor: pointer;
                padding: 0;
                margin-left: 5px;
              "
            >
              Resend
            </button>
          </div>
        </form>

        <!-- Step 3: New Password -->
        <form id="resetPasswordForm" style="display: none">
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input
              type="password"
              id="newPassword"
              name="newPassword"
              placeholder="Min 8 characters"
              required
            />
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              placeholder="Confirm password"
              required
            />
          </div>

          <button type="submit" id="resetBtn" class="btn btn-primary">
            <span id="resetBtnText">Reset Password</span>
            <span
              id="resetBtnLoader"
              class="loader"
              style="display: none"
            ></span>
          </button>
        </form>

        <div
          class="form-links"
          style="justify-content: center; margin-top: 30px"
        >
          <span style="font-size: 13px; color: var(--text-light)"
            >Remembered it?
          </span>
          <a
            href="login.html"
            class="link-secondary"
            style="
              margin-left: 5px;
              font-weight: 700;
              color: var(--primary-black);
            "
            >Back to login</a
          >
        </div>
      </main>
    </div>

    <script src="../js/main.js"></script>
    <script src="../js/auth.js"></script>
    <script>
      let currentEmail = "";
      let currentOTP = "";

      // Get API base URL from window object (set in main.js)
      // Don't declare it here - it's already in auth.js
      const getApiUrl = () => {
        return window.API_BASE_URL || "https://pasugo.onrender.com";
      };

      // Step 1: Request OTP
      document
        .getElementById("forgotPasswordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("email").value.trim();
          const errorDiv = document.getElementById("errorMessage");
          const successDiv = document.getElementById("successMessage");
          const submitBtn = document.getElementById("submitBtn");
          const btnText = document.getElementById("btnText");
          const btnLoader = document.getElementById("btnLoader");

          errorDiv.style.display = "none";
          successDiv.style.display = "none";

          if (!email) {
            showError(errorDiv, "Please enter your email address");
            return;
          }

          // Loading state
          submitBtn.disabled = true;
          btnText.style.opacity = "0";
          btnLoader.style.display = "inline-block";

          try {
            const response = await fetch(
              `${getApiUrl()}/api/auth/forgot-password/request-otp`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ email }),
              },
            );

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.detail || "Failed to send reset code");
            }

            currentEmail = email;

            // Show OTP code for development debugging
            const otpCode = data?.data?.otp_code;
            const msg = otpCode
              ? `Reset code sent! Your code is: ${otpCode}`
              : data.message || "Reset code sent to your email";
            showSuccess(successDiv, msg);

            // Switch to OTP verification form
            setTimeout(() => {
              document.getElementById("forgotPasswordForm").style.display =
                "none";
              document.getElementById("verifyOTPForm").style.display = "block";
              document.getElementById("emailDisplay").textContent = email;
              document.getElementById("otp").focus();
              successDiv.style.display = "none";
            }, 1000);
          } catch (error) {
            showError(
              errorDiv,
              error.message || "Failed to send reset code. Please try again.",
            );
          } finally {
            submitBtn.disabled = false;
            btnText.style.opacity = "1";
            btnLoader.style.display = "none";
          }
        });

      // Step 2: Verify OTP
      document
        .getElementById("verifyOTPForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const otp = document.getElementById("otp").value.trim();
          const errorDiv = document.getElementById("errorMessage");
          const successDiv = document.getElementById("successMessage");
          const verifyBtn = document.getElementById("verifyBtn");
          const verifyBtnText = document.getElementById("verifyBtnText");
          const verifyBtnLoader = document.getElementById("verifyBtnLoader");

          errorDiv.style.display = "none";
          successDiv.style.display = "none";

          if (!otp || otp.length !== 6) {
            showError(errorDiv, "Please enter a valid 6-digit code");
            return;
          }

          verifyBtn.disabled = true;
          verifyBtnText.style.opacity = "0";
          verifyBtnLoader.style.display = "inline-block";

          try {
            // Note: OTP verification happens in the final reset step
            // This step just validates the OTP format and stores it
            currentOTP = otp;
            showSuccess(
              successDiv,
              "Code verified! Now set your new password.",
            );

            setTimeout(() => {
              document.getElementById("verifyOTPForm").style.display = "none";
              document.getElementById("resetPasswordForm").style.display =
                "block";
              document.getElementById("newPassword").focus();
              successDiv.style.display = "none";
            }, 1000);
          } catch (error) {
            showError(errorDiv, error.message || "OTP verification failed");
          } finally {
            verifyBtn.disabled = false;
            verifyBtnText.style.opacity = "1";
            verifyBtnLoader.style.display = "none";
          }
        });

      // Step 3: Reset Password with OTP
      document
        .getElementById("resetPasswordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;
          const errorDiv = document.getElementById("errorMessage");
          const successDiv = document.getElementById("successMessage");
          const resetBtn = document.getElementById("resetBtn");
          const resetBtnText = document.getElementById("resetBtnText");
          const resetBtnLoader = document.getElementById("resetBtnLoader");

          errorDiv.style.display = "none";
          successDiv.style.display = "none";

          if (!newPassword || !confirmPassword) {
            showError(errorDiv, "Please enter both passwords");
            return;
          }

          if (newPassword.length < 8) {
            showError(errorDiv, "Password must be at least 8 characters");
            return;
          }

          if (newPassword !== confirmPassword) {
            showError(errorDiv, "Passwords do not match");
            return;
          }

          resetBtn.disabled = true;
          resetBtnText.style.opacity = "0";
          resetBtnLoader.style.display = "inline-block";

          try {
            const response = await fetch(
              `${getApiUrl()}/api/auth/forgot-password/reset`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  email: currentEmail,
                  otp: currentOTP,
                  new_password: newPassword,
                }),
              },
            );

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.detail || "Failed to reset password");
            }

            showSuccess(
              successDiv,
              "Password reset successfully! Redirecting to login...",
            );

            setTimeout(() => {
              window.location.href = "login.html";
            }, 2000);
          } catch (error) {
            showError(
              errorDiv,
              error.message || "Failed to reset password. Please try again.",
            );
          } finally {
            resetBtn.disabled = false;
            resetBtnText.style.opacity = "1";
            resetBtnLoader.style.display = "none";
          }
        });

      // Resend OTP
      document
        .getElementById("resendBtn")
        .addEventListener("click", async (e) => {
          e.preventDefault();

          const errorDiv = document.getElementById("errorMessage");
          const successDiv = document.getElementById("successMessage");
          const resendBtn = document.getElementById("resendBtn");

          errorDiv.style.display = "none";
          successDiv.style.display = "none";

          resendBtn.disabled = true;
          resendBtn.textContent = "Sending...";

          try {
            const response = await fetch(`${getApiUrl()}/api/auth/otp/resend`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: currentEmail,
                otp_type: "password_reset",
              }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.detail || "Failed to resend code");
            }

            showSuccess(
              successDiv,
              data.message || "New code sent to your email",
            );
            document.getElementById("otp").value = "";
            document.getElementById("otp").focus();
          } catch (error) {
            showError(
              errorDiv,
              error.message || "Failed to resend code. Please try again.",
            );
          } finally {
            resendBtn.disabled = false;
            resendBtn.textContent = "Resend";
          }
        });

      function showError(element, message) {
        element.textContent = message;
        element.style.display = "block";
        element.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }

      function showSuccess(element, message) {
        element.textContent = message;
        element.style.display = "block";
        element.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    </script>
  </body>
</html>
