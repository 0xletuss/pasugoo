<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map-Rider Diagnostic</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        padding: 20px;
        background: #1e1e1e;
        color: #d4d4d4;
        max-width: 800px;
        margin: 0 auto;
      }
      .card {
        background: #2d2d2d;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid #4285f4;
      }
      .card.error {
        border-left-color: #dc3545;
      }
      .card.success {
        border-left-color: #28a745;
      }
      h2 {
        color: #4285f4;
        margin-top: 0;
      }
      button {
        background: #4285f4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 13px;
      }
      button:hover {
        background: #357ae8;
      }
      pre {
        background: #1e1e1e;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
        font-size: 12px;
      }
      .status {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        background: #3d3d3d;
      }
      .status.ok {
        background: #1a3a1a;
        color: #28a745;
      }
      .status.bad {
        background: #3a1a1a;
        color: #dc3545;
      }
    </style>
  </head>
  <body>
    <h1>üîß map-rider.js Diagnostic</h1>

    <div class="card">
      <h2>1Ô∏è‚É£ Environment Check</h2>
      <button onclick="checkEnvironment()">Check Environment</button>
      <div id="envOutput"></div>
    </div>

    <div class="card">
      <h2>2Ô∏è‚É£ Test RiderMapController</h2>
      <button onclick="testController()">Test Controller Creation</button>
      <div id="controllerOutput"></div>
    </div>

    <div class="card">
      <h2>3Ô∏è‚É£ Test Map Element</h2>
      <button onclick="testMapElement()">Check Map Element</button>
      <div id="mapOutput"></div>
    </div>

    <div class="card">
      <h2>4Ô∏è‚É£ Test Leaflet</h2>
      <button onclick="testLeaflet()">Check Leaflet Library</button>
      <div id="leafletOutput"></div>
    </div>

    <div class="card">
      <h2>5Ô∏è‚É£ Test Window.riderMap</h2>
      <button onclick="testGlobalRiderMap()">Check window.riderMap</button>
      <div id="globalOutput"></div>
    </div>

    <div class="card">
      <h2>6Ô∏è‚É£ Test startTracking()</h2>
      <button onclick="testStartTracking()">Simulate "Go Online"</button>
      <div id="trackingOutput"></div>
    </div>

    <script>
      function log(message, containerId, isError = false) {
        const container = document.getElementById(containerId);
        const div = document.createElement("div");
        div.className = `status ${isError ? "bad" : "ok"}`;
        div.textContent = message;
        container.appendChild(div);
      }

      function checkEnvironment() {
        const output = document.getElementById("envOutput");
        output.innerHTML = "";

        const token = localStorage.getItem("access_token");
        const userData = localStorage.getItem("user_data");

        log(
          `‚úÖ Token: ${token ? "Found (" + token.length + " chars)" : "‚ùå NOT FOUND"}`,
          "envOutput",
          !token,
        );

        if (userData) {
          try {
            const user = JSON.parse(userData);
            log(
              `‚úÖ User: ${user.full_name} (${user.user_type})`,
              "envOutput",
              false,
            );
          } catch (e) {
            log(`‚ùå User data parse error: ${e.message}`, "envOutput", true);
          }
        } else {
          log(`‚ùå User data: NOT FOUND`, "envOutput", true);
        }

        log(
          `‚úÖ Leaflet: ${window.L ? "Loaded" : "‚ùå NOT LOADED"}`,
          "envOutput",
          !window.L,
        );
      }

      function testController() {
        const output = document.getElementById("controllerOutput");
        output.innerHTML = "";

        try {
          if (typeof RiderMapController === "undefined") {
            log(
              `‚ùå RiderMapController class not defined!`,
              "controllerOutput",
              true,
            );
            return;
          }
          log(`‚úÖ RiderMapController class exists`, "controllerOutput", false);

          const controller = new RiderMapController();
          log(`‚úÖ Controller instance created`, "controllerOutput", false);
          log(
            `‚úÖ isAuthenticated: ${controller.isAuthenticated}`,
            "controllerOutput",
            !controller.isAuthenticated,
          );
          log(
            `‚úÖ isTracking: ${controller.isTracking}`,
            "controllerOutput",
            false,
          );
          log(`‚úÖ isOnline: ${controller.isOnline}`, "controllerOutput", false);
        } catch (e) {
          log(
            `‚ùå Error creating controller: ${e.message}`,
            "controllerOutput",
            true,
          );
          log(`Stack: ${e.stack}`, "controllerOutput", true);
        }
      }

      function testMapElement() {
        const output = document.getElementById("mapOutput");
        output.innerHTML = "";

        const mapEl = document.getElementById("riderMap");
        log(
          `‚úÖ #riderMap element: ${mapEl ? "EXISTS" : "‚ùå NOT FOUND"}`,
          "mapOutput",
          !mapEl,
        );

        if (mapEl) {
          log(`‚úÖ Width: ${mapEl.offsetWidth}px`, "mapOutput", false);
          log(`‚úÖ Height: ${mapEl.offsetHeight}px`, "mapOutput", false);
          log(
            `Display: ${window.getComputedStyle(mapEl).display}`,
            "mapOutput",
            false,
          );
        }
      }

      function testLeaflet() {
        const output = document.getElementById("leafletOutput");
        output.innerHTML = "";

        log(
          `‚úÖ window.L: ${window.L ? "EXISTS" : "‚ùå NOT FOUND"}`,
          "leafletOutput",
          !window.L,
        );

        if (window.L) {
          log(
            `‚úÖ L.map: ${L.map ? "Available" : "‚ùå NOT AVAILABLE"}`,
            "leafletOutput",
            !L.map,
          );
          log(
            `‚úÖ L.marker: ${L.marker ? "Available" : "‚ùå NOT AVAILABLE"}`,
            "leafletOutput",
            !L.marker,
          );
          log(
            `‚úÖ L.tileLayer: ${L.tileLayer ? "Available" : "‚ùå NOT AVAILABLE"}`,
            "leafletOutput",
            !L.tileLayer,
          );
          log(
            `‚úÖ L.circle: ${L.circle ? "Available" : "‚ùå NOT AVAILABLE"}`,
            "leafletOutput",
            !L.circle,
          );
        }
      }

      function testGlobalRiderMap() {
        const output = document.getElementById("globalOutput");
        output.innerHTML = "";

        log(
          `‚úÖ window.riderMap: ${window.riderMap ? "EXISTS" : "‚ùå NOT FOUND"}`,
          "globalOutput",
          !window.riderMap,
        );

        if (window.riderMap) {
          log(
            `‚úÖ riderMap.map: ${window.riderMap.map ? "EXISTS" : "‚ùå NOT FOUND"}`,
            "globalOutput",
            !window.riderMap.map,
          );
          log(
            `‚úÖ riderMap.startTracking: ${typeof window.riderMap.startTracking === "function" ? "Function" : "‚ùå NOT A FUNCTION"}`,
            "globalOutput",
            typeof window.riderMap.startTracking !== "function",
          );
          log(
            `‚úÖ riderMap.stopTracking: ${typeof window.riderMap.stopTracking === "function" ? "Function" : "‚ùå NOT A FUNCTION"}`,
            "globalOutput",
            typeof window.riderMap.stopTracking !== "function",
          );
        }
      }

      function testStartTracking() {
        const output = document.getElementById("trackingOutput");
        output.innerHTML = "";

        try {
          if (!window.riderMap) {
            log(`‚ùå window.riderMap not found!`, "trackingOutput", true);
            return;
          }

          log(`‚úÖ Calling startTracking()...`, "trackingOutput", false);
          window.riderMap.startTracking();
          log(
            `‚úÖ startTracking() completed without error`,
            "trackingOutput",
            false,
          );
          log(
            `‚úÖ isTracking: ${window.riderMap.isTracking}`,
            "trackingOutput",
            false,
          );
          log(
            `‚úÖ isOnline: ${window.riderMap.isOnline}`,
            "trackingOutput",
            false,
          );
        } catch (e) {
          log(
            `‚ùå Error in startTracking(): ${e.message}`,
            "trackingOutput",
            true,
          );
          log(`Stack: ${e.stack}`, "trackingOutput", true);
        }
      }

      window.addEventListener("load", () => {
        console.log("Diagnostic page loaded");
        console.log("RiderMapController:", typeof RiderMapController);
        console.log("window.riderMap:", window.riderMap);
      });
    </script>
  </body>
</html>
